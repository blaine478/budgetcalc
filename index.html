<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Budgeting and Layoff Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { margin: 20px; }
        #status { color: green; }
        #warning { color: red; }
        #datePickerInput { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Employee Budgeting and Layoff Planner</h1>

        <div class="mb-3">
            <label for="employeeFile" class="form-label">Upload Employee Data (Excel: LastName, FirstName, Position, HourlyPay)</label>
            <input type="file" class="form-control" id="employeeFile" accept=".xlsx">
        </div>

        <h3>Build Work Schedule</h3>
        <p>Select multiple work days using the calendar (hold Ctrl/Cmd to pick non-consecutive days, or select ranges with Shift). Assign hours for each day.</p>
        <button class="btn btn-secondary mb-3" onclick="datePicker.open()">Add Work Days</button>
        <input id="datePickerInput">
        <table class="table table-striped" id="scheduleTable">
            <thead>
                <tr>
                    <th>Date (YYYY-MM-DD)</th>
                    <th>Hours</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Add New Hires</h3>
        <button class="btn btn-secondary mb-3" onclick="addNewHireRow()">Add New Hire</button>
        <table class="table table-striped" id="newHiresTable">
            <thead>
                <tr>
                    <th>Last Name</th>
                    <th>First Name</th>
                    <th>Position</th>
                    <th>Hourly Rate</th>
                    <th>Hire Date (YYYY-MM-DD)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="mb-3">
            <label for="budget" class="form-label">Total Budget</label>
            <input type="number" class="form-control" id="budget" step="0.01" min="0">
        </div>

        <button class="btn btn-primary" onclick="loadDataAndCompute()">Load Data and Generate Plan</button>

        <h2 class="mt-4">Proposed Plan</h2>
        <table class="table table-striped" id="planTable">
            <thead>
                <tr>
                    <th>LastName</th>
                    <th>FirstName</th>
                    <th>Position</th>
                    <th>HourlyPay</th>
                    <th>StartDate</th>
                    <th>ProposedLayoff</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button class="btn btn-secondary mt-3" onclick="recalculateCost()" style="display:none;" id="recalcBtn">Recalculate Cost with Edits</button>
        <p id="status" class="mt-3"></p>
        <p id="warning" class="mt-1"></p>

        <button class="btn btn-success mt-3" onclick="generatePDF()" style="display:none;" id="pdfBtn">Generate and Download PDF</button>
    </div>

    <script>
        let employees = [];
        let schedule = [];
        let workDates = [];
        let dailyHours = {};
        let dailyMultipliers = {};
        let possibleEnds = [];
        let noLayoffDate = null;
        let budget = 0;
        let currentTotalCost = 0;
        const hoursOptions = [8, 9, 10, 11.5, 12];

        const datePicker = flatpickr("#datePickerInput", {
            dateFormat: "Y-m-d",
            minDate: "2025-07-18",
            mode: "multiple",
            onClose: function(selectedDates) {
                selectedDates.forEach(date => {
                    const selectedMoment = moment(date);
                    addScheduleRow(selectedMoment);
                });
                datePicker.clear(); // Clear selections for next use
            }
        });

        function addScheduleRow(date) {
            const dateStr = date.format('YYYY-MM-DD');
            const existingRows = Array.from(document.querySelectorAll('#scheduleTable tbody tr'));
            if (existingRows.some(row => row.cells[0].textContent === dateStr)) {
                return; // Skip if already added
            }

            const tbody = document.getElementById('scheduleTable').querySelector('tbody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${dateStr}</td>
                <td>
                    <select class="form-select">
                        ${hoursOptions.map(h => `<option value="${h}">${h}</option>`).join('')}
                    </select>
                </td>
                <td><button class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">Remove</button></td>
            `;
            tbody.appendChild(row);
        }

        function addNewHireRow() {
            const tbody = document.getElementById('newHiresTable').querySelector('tbody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="form-control" placeholder="Last Name"></td>
                <td><input type="text" class="form-control" placeholder="First Name"></td>
                <td><input type="text" class="form-control" placeholder="Position"></td>
                <td><input type="number" class="form-control" placeholder="Hourly Rate" step="0.01"></td>
                <td><input type="text" class="form-control" placeholder="YYYY-MM-DD"></td>
                <td><button class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove()">Remove</button></td>
            `;
            tbody.appendChild(row);
        }

        function parseExcel(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'binary', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, { dateNF: 'yyyy-mm-dd' });
                callback(json);
            };
            reader.readAsBinaryString(file);
        }

        function loadDataAndCompute() {
            const employeeFile = document.getElementById('employeeFile').files[0];
            budget = parseFloat(document.getElementById('budget').value);

            if (!employeeFile || isNaN(budget)) {
                alert('Please upload employee file and enter a budget.');
                return;
            }

            // Collect schedule from table
            schedule = [];
            const scheduleRows = Array.from(document.querySelectorAll('#scheduleTable tbody tr'));
            scheduleRows.forEach(row => {
                const dateStr = row.cells[0].textContent;
                const hours = parseFloat(row.cells[1].querySelector('select').value);
                schedule.push({Date: dateStr, Hours: hours});
            });

            if (schedule.length === 0) {
                alert('Please add at least one work day to the schedule.');
                return;
            }

            workDates = schedule.map(row => moment(row.Date, 'YYYY-MM-DD'));
            workDates.sort((a,b) => a - b);
            const startDate = workDates[0];
            const endDate = workDates[workDates.length - 1];
            noLayoffDate = endDate.clone().add(1, 'days');

            dailyHours = {};
            schedule.forEach(row => {
                const d = moment(row.Date, 'YYYY-MM-DD');
                dailyHours[d.format('YYYY-MM-DD')] = row.Hours;
            });

            dailyMultipliers = {};
            workDates.forEach(d => {
                const wd = d.day(); // 0=Sun, 6=Sat
                let mult = 1.0;
                if (wd === 6) mult = 1.5; // Saturday
                if (wd === 0) mult = 2.0; // Sunday
                dailyMultipliers[d.format('YYYY-MM-DD')] = mult;
            });

            // Possible ends not needed since no optimization, but keep for consistency
            let fridayDates = workDates.filter(d => d.day() === 5).sort((a,b) => a - b);
            fridayDates = [...new Set(fridayDates.map(d => d.format('YYYY-MM-DD')))].map(d => moment(d));
            possibleEnds = fridayDates.concat([noLayoffDate]);

            parseExcel(employeeFile, function(emps) {
                employees = emps.map(emp => ({
                    ...emp,
                    HourlyPay: parseFloat(emp.HourlyPay),
                    StartDate: emp.StartDate ? moment(emp.StartDate, 'YYYY-MM-DD') : startDate.clone()
                }));

                // Add new hires from table
                const newHireRows = Array.from(document.querySelectorAll('#newHiresTable tbody tr'));
                newHireRows.forEach(row => {
                    const last = row.cells[0].querySelector('input').value.trim();
                    const first = row.cells[1].querySelector('input').value.trim();
                    const pos = row.cells[2].querySelector('input').value.trim();
                    const pay = parseFloat(row.cells[3].querySelector('input').value);
                    const hDate = row.cells[4].querySelector('input').value.trim();
                    if (last && first && pos && !isNaN(pay) && moment(hDate, 'YYYY-MM-DD', true).isValid()) {
                        employees.push({
                            LastName: last,
                            FirstName: first,
                            Position: pos,
                            HourlyPay: pay,
                            StartDate: moment(hDate, 'YYYY-MM-DD')
                        });
                    } else if (last || first || pos || pay || hDate) {
                        alert('Invalid or incomplete new hire entry. Please fill all fields correctly.');
                        return;
                    }
                });

                // No optimization: set all to full period
                employees.forEach(emp => emp.ProposedLayoff = 'None (full period)');
                displayPlanTable();
                recalculateCost();
                document.getElementById('recalcBtn').style.display = 'block';
                document.getElementById('pdfBtn').style.display = 'block';
                updateCostDisplay();
            });
        }

        function displayPlanTable() {
            const tbody = document.getElementById('planTable').querySelector('tbody');
            tbody.innerHTML = '';
            employees.forEach((emp, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${emp.LastName}</td>
                    <td>${emp.FirstName}</td>
                    <td>${emp.Position}</td>
                    <td>${emp.HourlyPay.toFixed(2)}</td>
                    <td>${emp.StartDate.format('YYYY-MM-DD')}</td>
                    <td contenteditable="true" id="layoff_${idx}">${emp.ProposedLayoff}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function recalculateCost() {
            let totalCost = 0;
            let valid = true;
            employees.forEach((emp, idx) => {
                let layoff = document.getElementById(`layoff_${idx}`).innerText.trim();
                let endI;
                if (layoff === 'None (full period)') {
                    endI = noLayoffDate;
                } else {
                    endI = moment(layoff, 'YYYY-MM-DD').add(1, 'days'); // Work up to layoff day
                    if (!endI.isValid()) {
                        alert(`Invalid date for employee ${emp.FirstName} ${emp.LastName}: ${layoff}`);
                        valid = false;
                        return;
                    }
                }
                const startI = emp.StartDate;
                const payI = emp.HourlyPay;
                workDates.forEach(d => {
                    if (d.isSameOrAfter(startI) && d.isBefore(endI)) {
                        const h = dailyHours[d.format('YYYY-MM-DD')];
                        const mult = dailyMultipliers[d.format('YYYY-MM-DD')];
                        totalCost += h * payI * mult;
                    }
                });
            });
            if (!valid) return;
            currentTotalCost = totalCost;
            updateCostDisplay();
        }

        function updateCostDisplay() {
            document.getElementById('status').innerText = `Total calculated cost: $${currentTotalCost.toFixed(2)}`;
            if (currentTotalCost > budget) {
                document.getElementById('warning').innerText = 'Warning: Over budget!';
            } else {
                document.getElementById('warning').innerText = '';
            }
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text('Layoff and Work Plan', 10, 10);
            doc.text(`Budget: $${budget.toFixed(2)}`, 10, 20);
            doc.text(`Total Cost: $${currentTotalCost.toFixed(2)}`, 10, 30);

            // Add schedule table
            doc.text('Work Schedule', 10, 50);
            const scheduleData = schedule.map(row => [row.Date, row.Hours]);
            doc.autoTable({
                head: [['Date', 'Hours']],
                body: scheduleData,
                startY: 55
            });

            // Add plan table
            doc.text('Employee Plan', 10, doc.lastAutoTable.finalY + 20);
            const tableData = employees.map((emp, idx) => [
                emp.LastName,
                emp.FirstName,
                emp.Position,
                emp.HourlyPay.toFixed(2),
                emp.StartDate.format('YYYY-MM-DD'),
                document.getElementById(`layoff_${idx}`).innerText
            ]);

            doc.autoTable({
                head: [['LastName', 'FirstName', 'Position', 'HourlyPay', 'StartDate', 'ProposedLayoff']],
                body: tableData,
                startY: doc.lastAutoTable.finalY + 25
            });

            doc.save('layoff_plan.pdf');
        }
    </script>
</body>
</html>
