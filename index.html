<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Budgeting and Layoff Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { margin: 20px; }
        #status { color: green; }
        #warning { color: red; }
        #datePickerInput { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Employee Budgeting and Layoff Planner</h1>

        <div class="mb-3">
            <label for="employeeFile" class="form-label">Upload Employee Data (Excel)</label>
            <input type="file" class="form-control" id="employeeFile" accept=".xlsx">
        </div>

        <h3>Column Mapping for Employee Data</h3>
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="colLastName" class="form-label">Last Name Column</label>
                <input type="text" class="form-control" id="colLastName" value="Last Name">
            </div>
            <div class="col-md-3">
                <label for="colFirstName" class="form-label">First Name Column</label>
                <input type="text" class="form-control" id="colFirstName" value="First Name">
            </div>
            <div class="col-md-3">
                <label for="colPosition" class="form-label">Position Column</label>
                <input type="text" class="form-control" id="colPosition" value="Position">
            </div>
            <div class="col-md-3">
                <label for="colHourlyPay" class="form-label">Rate Column</label>
                <input type="text" class="form-control" id="colHourlyPay" value="Rate">
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-3">
                <label for="colStartDate" class="form-label">Start Date Column (Optional)</label>
                <input type="text" class="form-control" id="colStartDate" value="StartDate">
            </div>
        </div>

        <h3>Build Work Schedule</h3>
        <p>Select multiple work days using the calendar (hold Ctrl/Cmd to pick non-consecutive days, or select ranges with Shift). Assign hours for each day.</p>
        <button class="btn btn-secondary mb-3" onclick="datePicker.open()">Add Work Days</button>
        <input id="datePickerInput">
        <table class="table table-striped" id="scheduleTable">
            <thead>
                <tr>
                    <th>Date (YYYY-MM-DD)</th>
                    <th>Hours</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Add New Hires</h3>
        <button class="btn btn-secondary mb-3" onclick="addNewHireRow()">Add New Hire</button>
        <table class="table table-striped" id="newHiresTable">
            <thead>
                <tr>
                    <th>Last Name</th>
                    <th>First Name</th>
                    <th>Position</th>
                    <th>Hourly Rate</th>
                    <th>Hire Date (YYYY-MM-DD)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="mb-3">
            <label for="budget" class="form-label">Total Budget</label>
            <input type="number" class="form-control" id="budget" step="0.01" min="0">
        </div>

        <h2 class="mt-4">Plan</h2>
        <table class="table table-striped" id="planTable">
            <thead>
                <tr>
                    <th>Last Name</th>
                    <th>First Name</th>
                    <th>Position</th>
                    <th>Rate</th>
                    <th>Start Date</th>
                    <th>Proposed Layoff</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button class="btn btn-secondary mt-3" onclick="recalculateCost()" id="recalcBtn">Calculate Costs</button>
        <p id="status" class="mt-3"></p>
        <p id="warning" class="mt-1"></p>

        <h3 class="mt-4">Daily Costs</h3>
        <table class="table table-striped" id="dailyCostsTable">
            <thead id="dailyCostsHead"></thead>
            <tbody id="dailyCostsBody"></tbody>
        </table>

        <h3 class="mt-4">Weekly Costs</h3>
        <table class="table table-striped" id="weeklyCostsTable">
            <thead id="weeklyCostsHead"></thead>
            <tbody id="weeklyCostsBody"></tbody>
        </table>

        <button class="btn btn-success mt-3" onclick="generatePDF()" id="pdfBtn">Generate and Download PDF</button>
    </div>

    <script>
        let employees = [];
        let schedule = [];
        let workDates = [];
        let dailyHours = {};
        let dailyMultipliers = {};
        let noLayoffDate = null;
        let budget = 0;
        let currentTotalCost = 0;
        let dailyCosts = {}; // {date: {empIdx: cost, total: sum}}
        let weeklyCosts = {}; // {weekKey: {empIdx: cost, total: sum}}
        const hoursOptions = [8, 9, 10, 11.5, 12];

        const datePicker = flatpickr("#datePickerInput", {
            dateFormat: "Y-m-d",
            minDate: "2025-07-18",
            mode: "multiple",
            onClose: function(selectedDates) {
                selectedDates.forEach(date => {
                    const selectedMoment = moment(date);
                    addScheduleRow(selectedMoment);
                });
                datePicker.clear(); // Clear selections for next use
            }
        });

        function addScheduleRow(date) {
            const dateStr = date.format('YYYY-MM-DD');
            const existingRows = Array.from(document.querySelectorAll('#scheduleTable tbody tr'));
            if (existingRows.some(row => row.cells[0].textContent === dateStr)) {
                return; // Skip if already added
            }

            const tbody = document.getElementById('scheduleTable').querySelector('tbody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${dateStr}</td>
                <td>
                    <select class="form-select" onchange="updatePlan();">
                        ${hoursOptions.map(h => `<option value="${h}">${h}</option>`).join('')}
                    </select>
                </td>
                <td><button class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove(); updatePlan();">Remove</button></td>
            `;
            tbody.appendChild(row);
            updatePlan();
        }

        function addNewHireRow() {
            const tbody = document.getElementById('newHiresTable').querySelector('tbody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="form-control" placeholder="Last Name" oninput="updatePlan();"></td>
                <td><input type="text" class="form-control" placeholder="First Name" oninput="updatePlan();"></td>
                <td><input type="text" class="form-control" placeholder="Position" oninput="updatePlan();"></td>
                <td><input type="number" class="form-control" placeholder="Hourly Rate" step="0.01" oninput="updatePlan();"></td>
                <td><input type="text" class="form-control" placeholder="YYYY-MM-DD" oninput="updatePlan();"></td>
                <td><button class="btn btn-danger btn-sm" onclick="this.parentNode.parentNode.remove(); updatePlan();">Remove</button></td>
            `;
            tbody.appendChild(row);
            updatePlan();
        }

        function parseExcel(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'binary', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                callback(json);
            };
            reader.readAsBinaryString(file);
        }

        document.getElementById('employeeFile').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                parseExcel(file, loadEmployees);
            }
        });

        // Add event listeners to column mapping inputs to re-parse on change
        ['colLastName', 'colFirstName', 'colPosition', 'colHourlyPay', 'colStartDate'].forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                const file = document.getElementById('employeeFile').files[0];
                if (file) {
                    parseExcel(file, loadEmployees);
                }
            });
        });

        function loadEmployees(emps) {
            const colLast = document.getElementById('colLastName').value;
            const colFirst = document.getElementById('colFirstName').value;
            const colPos = document.getElementById('colPosition').value;
            const colPay = document.getElementById('colHourlyPay').value;
            const colStart = document.getElementById('colStartDate').value || null;

            employees = emps.map(emp => ({
                LastName: emp[colLast] || '',
                FirstName: emp[colFirst] || '',
                Position: emp[colPos] || '',
                HourlyPay: parseFloat(emp[colPay]) || 0,
                StartDate: colStart && emp[colStart] ? moment(emp[colStart], 'YYYY-MM-DD') : moment('2025-07-18')
            })).filter(emp => emp.LastName && emp.FirstName && emp.Position && emp.HourlyPay > 0);
            updatePlan();
        }

        document.getElementById('budget').addEventListener('input', function() {
            budget = parseFloat(this.value) || 0;
            updateCostDisplay();
        });

        function updatePlan() {
            // Collect schedule
            schedule = [];
            const scheduleRows = Array.from(document.querySelectorAll('#scheduleTable tbody tr'));
            scheduleRows.forEach(row => {
                const dateStr = row.cells[0].textContent;
                const hours = parseFloat(row.cells[1].querySelector('select').value);
                schedule.push({Date: dateStr, Hours: hours});
            });

            workDates = schedule.map(row => moment(row.Date, 'YYYY-MM-DD'));
            workDates.sort((a,b) => a - b);
            const endDate = workDates.length > 0 ? workDates[workDates.length - 1] : moment();
            noLayoffDate = endDate.clone().add(1, 'days');

            dailyHours = {};
            schedule.forEach(row => {
                const d = moment(row.Date, 'YYYY-MM-DD');
                dailyHours[d.format('YYYY-MM-DD')] = row.Hours;
            });

            dailyMultipliers = {};
            workDates.forEach(d => {
                const wd = d.day(); // 0=Sun, 6=Sat
                let mult = 1.0;
                if (wd === 6) mult = 1.5; // Saturday
                if (wd === 0) mult = 2.0; // Sunday
                dailyMultipliers[d.format('YYYY-MM-DD')] = mult;
            });

            // Add new hires
            const tempEmployees = [...employees];
            const newHireRows = Array.from(document.querySelectorAll('#newHiresTable tbody tr'));
            newHireRows.forEach(row => {
                const last = row.cells[0].querySelector('input').value.trim();
                const first = row.cells[1].querySelector('input').value.trim();
                const pos = row.cells[2].querySelector('input').value.trim();
                const pay = parseFloat(row.cells[3].querySelector('input').value);
                const hDate = row.cells[4].querySelector('input').value.trim();
                if (last && first && pos && !isNaN(pay) && moment(hDate, 'YYYY-MM-DD', true).isValid()) {
                    tempEmployees.push({
                        LastName: last,
                        FirstName: first,
                        Position: pos,
                        HourlyPay: pay,
                        StartDate: moment(hDate, 'YYYY-MM-DD')
                    });
                }
            });

            // Set or preserve layoffs
            tempEmployees.forEach((emp, idx) => {
                if (!emp.ProposedLayoff) {
                    emp.ProposedLayoff = 'None (full period)';
                }
            });

            employees = tempEmployees;
            displayPlanTable();
        }

        function displayPlanTable() {
            const tbody = document.getElementById('planTable').querySelector('tbody');
            tbody.innerHTML = '';
            employees.forEach((emp, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${emp.LastName}</td>
                    <td>${emp.FirstName}</td>
                    <td>${emp.Position}</td>
                    <td>${emp.HourlyPay.toFixed(2)}</td>
                    <td>${emp.StartDate.format('YYYY-MM-DD')}</td>
                    <td contenteditable="true" id="layoff_${idx}" oninput="updatePlan();">${emp.ProposedLayoff}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function recalculateCost() {
            dailyCosts = {};
            weeklyCosts = {};
            let totalCost = 0;
            let valid = true;
            employees.forEach((emp, idx) => {
                let layoff = document.getElementById(`layoff_${idx}`).innerText.trim();
                emp.ProposedLayoff = layoff;
                let endI;
                if (layoff === 'None (full period)') {
                    endI = noLayoffDate;
                } else {
                    endI = moment(layoff, 'YYYY-MM-DD').add(1, 'days');
                    if (!endI.isValid()) {
                        alert(`Invalid date for employee ${emp.FirstName} ${emp.LastName}: ${layoff}`);
                        valid = false;
                        return;
                    }
                }
                const startI = emp.StartDate;
                const payI = emp.HourlyPay;
                workDates.forEach(d => {
                    if (d.isSameOrAfter(startI) && d.isBefore(endI)) {
                        const dateStr = d.format('YYYY-MM-DD');
                        const h = dailyHours[dateStr];
                        const mult = dailyMultipliers[dateStr];
                        const ot_h = Math.max(h - 8, 0);
                        const base_cost = h * payI * mult;
                        const ot_cost = ot_h * payI * 0.5;
                        const day_cost = base_cost + ot_cost;
                        if (!dailyCosts[dateStr]) dailyCosts[dateStr] = {total: 0};
                        dailyCosts[dateStr][idx] = day_cost;
                        dailyCosts[dateStr].total += day_cost;

                        const weekKey = d.format('YYYY-WW'); // e.g., 2025-30
                        if (!weeklyCosts[weekKey]) weeklyCosts[weekKey] = {total: 0};
                        if (!weeklyCosts[weekKey][idx]) weeklyCosts[weekKey][idx] = 0;
                        weeklyCosts[weekKey][idx] += day_cost;
                        weeklyCosts[weekKey].total += day_cost;
                    }
                });
            });
            if (!valid) return;

            Object.keys(dailyCosts).forEach(date => {
                totalCost += dailyCosts[date].total;
            });
            currentTotalCost = totalCost;

            displayDailyCosts();
            displayWeeklyCosts();
            updateCostDisplay();
        }

        function displayDailyCosts() {
            const sortedDates = Object.keys(dailyCosts).sort();
            const head = document.getElementById('dailyCostsHead');
            head.innerHTML = `<tr><th>Employee</th>${sortedDates.map(date => `<th>${date}</th>`).join('')}<th>Total</th></tr>`;

            const body = document.getElementById('dailyCostsBody');
            body.innerHTML = '';
            let grandTotal = 0;
            employees.forEach((emp, idx) => {
                let rowTotal = 0;
                let row = `<td>${emp.FirstName} ${emp.LastName}</td>`;
                sortedDates.forEach(date => {
                    const cost = dailyCosts[date][idx] || 0;
                    row += `<td>$${cost.toFixed(2)}</td>`;
                    rowTotal += cost;
                });
                row += `<td>$${rowTotal.toFixed(2)}</td>`;
                body.innerHTML += `<tr>${row}</tr>`;
                grandTotal += rowTotal;
            });
            let totalRow = `<td>Total</td>`;
            sortedDates.forEach(date => {
                totalRow += `<td>$${dailyCosts[date].total.toFixed(2)}</td>`;
            });
            totalRow += `<td>$${grandTotal.toFixed(2)}</td>`;
            body.innerHTML += `<tr>${totalRow}</tr>`;
        }

        function displayWeeklyCosts() {
            const sortedWeeks = Object.keys(weeklyCosts).sort();
            const head = document.getElementById('weeklyCostsHead');
            head.innerHTML = `<tr><th>Employee</th>${sortedWeeks.map(week => `<th>Week ${week}</th>`).join('')}<th>Total</th></tr>`;

            const body = document.getElementById('weeklyCostsBody');
            body.innerHTML = '';
            let grandTotal = 0;
            employees.forEach((emp, idx) => {
                let rowTotal = 0;
                let row = `<td>${emp.FirstName} ${emp.LastName}</td>`;
                sortedWeeks.forEach(week => {
                    const cost = weeklyCosts[week][idx] || 0;
                    row += `<td>$${cost.toFixed(2)}</td>`;
                    rowTotal += cost;
                });
                row += `<td>$${rowTotal.toFixed(2)}</td>`;
                body.innerHTML += `<tr>${row}</tr>`;
                grandTotal += rowTotal;
            });
            let totalRow = `<td>Total</td>`;
            sortedWeeks.forEach(week => {
                totalRow += `<td>$${weeklyCosts[week].total.toFixed(2)}</td>`;
            });
            totalRow += `<td>$${grandTotal.toFixed(2)}</td>`;
            body.innerHTML += `<tr>${totalRow}</tr>`;
        }

        function updateCostDisplay() {
            document.getElementById('status').innerText = `Total calculated cost: $${currentTotalCost.toFixed(2)}`;
            if (currentTotalCost > budget) {
                document.getElementById('warning').innerText = 'Warning: Over budget!';
            } else {
                document.getElementById('warning').innerText = '';
            }
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text('Layoff and Work Plan', 10, 10);
            doc.text(`Budget: $${budget.toFixed(2)}`, 10, 20);
            doc.text(`Total Cost: $${currentTotalCost.toFixed(2)}`, 10, 30);

            // Add schedule table
            doc.text('Work Schedule', 10, 50);
            const scheduleData = schedule.map(row => [row.Date, row.Hours]);
            doc.autoTable({
                head: [['Date', 'Hours']],
                body: scheduleData,
                startY: 55
            });

            // Add employee plan table
            doc.text('Employee Plan', 10, doc.lastAutoTable.finalY + 20);
            const tableData = employees.map(emp => [
                emp.LastName,
                emp.FirstName,
                emp.Position,
                emp.HourlyPay.toFixed(2),
                emp.StartDate.format('YYYY-MM-DD'),
                emp.ProposedLayoff
            ]);
            doc.autoTable({
                head: [['Last Name', 'First Name', 'Position', 'Rate', 'Start Date', 'Proposed Layoff']],
                body: tableData,
                startY: doc.lastAutoTable.finalY + 25
            });

            // Add daily costs
            doc.addPage();
            doc.text('Daily Costs', 10, 10);
            const sortedDates = Object.keys(dailyCosts).sort();
            const dailyHead = [['Employee', ...sortedDates, 'Total']];
            const dailyBody = employees.map((emp, idx) => {
                let rowTotal = 0;
                const costs = sortedDates.map(date => {
                    const cost = dailyCosts[date][idx] || 0;
                    rowTotal += cost;
                    return `$${cost.toFixed(2)}`;
                });
                return [`${emp.FirstName} ${emp.LastName}`, ...costs, `$${rowTotal.toFixed(2)}`];
            });
            const dailyTotalRow = ['Total', ...sortedDates.map(date => `$${dailyCosts[date].total.toFixed(2)}`), `$${currentTotalCost.toFixed(2)}`];
            dailyBody.push(dailyTotalRow);
            doc.autoTable({
                head: dailyHead,
                body: dailyBody,
                startY: 15
            });

            // Add weekly costs
            doc.addPage();
            doc.text('Weekly Costs', 10, 10);
            const sortedWeeks = Object.keys(weeklyCosts).sort();
            const weeklyHead = [['Employee', ...sortedWeeks.map(week => `Week ${week}`), 'Total']];
            const weeklyBody = employees.map((emp, idx) => {
                let rowTotal = 0;
                const costs = sortedWeeks.map(week => {
                    const cost = weeklyCosts[week][idx] || 0;
                    rowTotal += cost;
                    return `$${cost.toFixed(2)}`;
                });
                return [`${emp.FirstName} ${emp.LastName}`, ...costs, `$${rowTotal.toFixed(2)}`];
            });
            const weeklyTotalRow = ['Total', ...sortedWeeks.map(week => `$${weeklyCosts[week].total.toFixed(2)}`), `$${currentTotalCost.toFixed(2)}`];
            weeklyBody.push(weeklyTotalRow);
            doc.autoTable({
                head: weeklyHead,
                body: weeklyBody,
                startY: 15
            });

            doc.save('layoff_plan.pdf');
        }
    </script>
</body>
</html>
